<!DOCTYPE html>
<html>
	<head>
		<script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
		<script src="https://js.leapmotion.com/leap-0.6.4.min.js"></script>
		<script src="https://unpkg.com/aframe-leap-hands/dist/aframe-leap-hands.min.js"></script>
		<script src="https://unpkg.com/aframe-physics-system@1.4.0/dist/aframe-physics-system.min.js"></script>
		<script src="https://unpkg.com/aframe-firebase-component@^4.0.0/dist/aframe-firebase-component.min.js"></script>
		<script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
		<script src="https://unpkg.com/aframe-entity-generator-component@^3.0.0/dist/aframe-entity-generator-component.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.3/howler.js"></script>

		<script>
			// controls unit conversion ratio between what we get back from the Leap and what CANNON.js takes
			// by default, just converting from millimeters to meters (1000) is too slow, so  go for something smaller than that
			const leapToCANNONRatio = 100;

			AFRAME.registerComponent('holdable', {
				schema: {activeColor: {default: 'orange'}},
				init() {
					this.physics 	= this.el.sceneEl.systems.physics;
					this.constraint = null;
					this.handID 	= null;
					this.el.addEventListener('leap-holdstart', this.onHoldStart.bind(this));
					this.el.addEventListener('leap-holdstop', this.onHoldStop.bind(this));
					console.log('initialized');
				},
				onHoldStart(e) {
					if (this.handID) return;
					this.originalColor = this.el.getAttribute('material').color;
					this.el.setAttribute('material', 'color', this.data.activeColor);
					this.constraint = new CANNON.LockConstraint(this.el.body, e.detail.body);
					this.physics.world.addConstraint(this.constraint);
					this.handID = e.detail.handID;
					console.log('holding');
				},
				onHoldStop(e) {
					if (e.detail.handID !== this.handID) return;
					this.el.setAttribute('material', 'color', this.originalColor);
					this.physics.world.removeConstraint(this.constraint);
					this.constraint = null;
					this.handID 	= null;
					this.el.body.velocity = new CANNON.Vec3(...speed.map(s => s / leapToCANNONRatio));
					console.log('thrown: ' + speed);
          var swoosh = new Howl({
            src: ["swoosh.mp3"],
            autoplay: true,
            loop: false,
            volume: 1.0
          }).play();
				}
			});
		</script>
	</head>
	<body>
    <script>
      var songSelection = (Math.floor(Math.random() * (100 - 1)) + 1);
      if(songSelection < 6) {
        var sound = new Howl({
          src: ["first.mp3", "first.mp3"],
          autoplay: true,
          loop: true,
          volume: 0.7
        });
      } else {
        var sound = new Howl({
          src: ["second.mp3", "second.mp3"],
          autoplay: true,
          loop: true,
          volume: 1.0
        });
      }
      sound.play();

    </script>
		<script>
			const controller = new Leap.Controller({
				enableGestures: true,
				frameEventName: 'animationFrame'
			});

			let speed = [0, 0, 0];

			controller.on('frame', frame => {
				if (frame.hands.length != 0) {
					speed = frame.hands[0].palmVelocity;
				}
			});
			controller.connect();
		</script>

		<!-- https://github.com/ngokevin/kframe/tree/master/components/firebase -->
		<a-scene physics="gravity: 0" firebase="apiKey: AIzaSyCfSH6Ow32uPpMxBAA4PTrgBUiM72hSKqk;
												 authDomain: chicagohacks2017.firebaseapp.com;
												 databaseURL: https://chicagohacks2017.firebaseio.com;
												 storageBucket: chicagohacks2017.appspot.com">
			<a-assets>
				<!-- <a-mixin id="ball" holdable dynamic-body="shape: sphere; sphereRadius: 0.1" random-position="min: -12.5 0 -12.5; max: 12.5 25 12.5" geometry="primitive: sphere; radius: 0.1" firebase-broadcast="componentsOnce: mixin; components: position"></a-mixin> -->
				<a-mixin id="ball" holdable dynamic-body="shape: sphere; sphereRadius: 0.1" random-position="min: -12.5 0 -12.5; max: 12.5 25 12.5" geometry="primitive: sphere; radius: 0.1"></a-mixin>
				<a-mixin id="player-model"></a-mixin>
				<!--<a-mixin iid="obstacle" static-body="shape: dodecahedron" random-position="min: -12.5 0 -12.5; max: 12.5 25 12.5" random-rotation="min: 0 0 0; max: 360 360 360" geometry="primitive: dodecahedron; radius: 2.5" firebase-broadcast="componentsOnce: mixin, position"></a-mixin>-->
				<a-mixin id="obstacle" static-body="shape: dodecahedron" random-position="min: -12.5 0 -12.5; max: 12.5 25 12.5" random-rotation="min: 0 0 0; max: 360 360 360" geometry="primitive: dodecahedron; radius: 2.5"></a-mixin>
			</a-assets>
			<a-box width="10" height="10" depth=".5" color="blue" holdable position="0 0 -8" static-body="shape: box"></a-box>
			<a-sphere radius=".3" position="0.125 4 -4" color="red" holdable dynamic-body="shape: sphere"></a-sphere>
			<a-plane static-body position="0 0 -4" rotation="-90 0 0" width="40" height="40" color="#7BC8A4"></a-plane>
			<a-sky src="https://cdn.glitch.com/b870d9ec-1139-44f9-b462-223e4a2c74e7%2Fsechelt.jpg?1490307995926"></a-sky>
			<a-entity entity-generator="mixin: ball; num: 10" firebase-broadcast="componentsOnce: mixin; components: position"></a-entity>
			<a-entity entity-generator="mixin: obstacle; num: 7" firebase-broadcast="componentsOnce: mixin, position"></a-entity>
			<a-sphere id="player" radius="1" static-body="shape: sphere; sphereRadius: 1" camera="near: 0.01;" look-controls wasd-controls position="0 1 0">
			<!-- <a-entity dynamic-body camera="near: 0.01" look-controls position="0 1.5 0"> -->
				<a-entity id="left" leap-hand="hand: left; enablePhysics: true; holdDistance: 1"></a-entity>
				<a-entity id="right" leap-hand="hand: right; enablePhysics: true; holdDistance: 1"></a-entity>
				<a-octahedron id="life-1" color="#FF926B" radius="0.1" position="0.3 0.6 -1"></a-octahedron>
				<a-octahedron id="life-2" color="#FF926B" radius="0.1" position="0.6 0.6 -1"></a-octahedron>
				<a-octahedron id="life-3" color="#FF926B" radius="0.1" position="0.9 0.6 -1"></a-octahedron>
			</a-sphere>
		</a-scene>
		<script>
			let playerEl = document.querySelector('#player');
			let lives = 3;
			playerEl.addEventListener('body-loaded', bodyEvent => {
				bodyEvent.detail.body.addEventListener('collide', () => {
					let lifeEl = document.querySelector('#life-' + lives);
					playerEl.removeChild(lifeEl);
					lives--;
				});
			});
		</script>
	</body>
</html>
