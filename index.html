<!DOCTYPE html>
<html>
	<head>
		<script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
		<script src="https://js.leapmotion.com/leap-0.6.4.min.js"></script>
		<script src="https://unpkg.com/aframe-leap-hands/dist/aframe-leap-hands.min.js"></script>
		<script src="https://unpkg.com/aframe-physics-system@1.4.0/dist/aframe-physics-system.min.js"></script>
		<script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
		<script src="https://unpkg.com/aframe-entity-generator-component@^3.0.0/dist/aframe-entity-generator-component.min.js"></script>

		<script>
			// controls unit conversion ratio between what we get back from the Leap and what CANNON.js takes
			// by default, just converting from millimeters to meters (1000) is too slow, so  go for something smaller than that
			const leapToCANNONRatio = 100;

			AFRAME.registerComponent('holdable', {
				schema: {activeColor: {default: 'orange'}},
				init() {
					this.physics 	= this.el.sceneEl.systems.physics;
					this.constraint = null;
					this.handID 	= null;
					this.el.addEventListener('leap-holdstart', this.onHoldStart.bind(this));
					this.el.addEventListener('leap-holdstop', this.onHoldStop.bind(this));
					console.log('initialized');
				},
				onHoldStart(e) {
					if (this.handID) return;
					this.originalColor = this.el.getAttribute('material').color;
					this.el.setAttribute('material', 'color', this.data.activeColor);
					this.constraint = new CANNON.LockConstraint(this.el.body, e.detail.body);
					this.physics.world.addConstraint(this.constraint);
					this.handID = e.detail.handID;
					console.log('holding');
				},
				onHoldStop(e) {
					if (e.detail.handID !== this.handID) return;
					this.el.setAttribute('material', 'color', this.originalColor);
					this.physics.world.removeConstraint(this.constraint);
					this.constraint = null;
					this.handID 	= null;
					this.el.body.velocity = new CANNON.Vec3(...speed.map(s => s / leapToCANNONRatio));
					console.log('thrown: ' + speed);
				}
			});
		</script>
	</head>
	<body>
		<script>
			// controller
			const controller = new Leap.Controller({
				enableGestures: true,
				frameEventName: 'animationFrame'
			});
			let speed = [0, 0, 0];
			controller.on('frame', frame => {
				if (frame.hands.length != 0) {
					speed = frame.hands[0].palmVelocity;
				}
			});
			controller.connect();

		
			// generate map
			function generateMap(xSize, ySize, zSize, obstacles, dodgeballs) {
				var result = "";

				function createWall(xSize, ySize, zSize, xPos, yPos, zPos) {
					var boxEl = document.createElement('a-box');
					boxEl.setAttribute('material', {color: '#fefefe', opacity: '.5'});
					boxEl.setAttribute('position', {x: xPos, y: yPos, z: zPos});
					boxEl.setAttribute('width', xSize);
					boxEl.setAttribute('height', ySize);
					boxEl.setAttribute('depth', zSize);
					boxEl.setAttribute('static-body', 'shape: box');
					boxEl.setAttribute('holdable');
					var sceneEl = document.querySelector('a-scene');
					sceneEl.appendChild(boxEl);
				}

				createWall(xSize, .5, zSize, 0, ySize / 2, 0);
				createWall(xSize, .5, zSize, 0, -ySize / 2, 0);
				createWall(xSize, ySize, .5, 0, 0, zSize / 2);
				createWall(xSize, ySize, .5, 0, 0, -zSize / 2);
				createWall(.5, ySize, zSize, xSize / 2, 0, 0);
				createWall(.5, ySize, zSize, -xSize / 2, 0, 0);

				for (var i = 0; i < obstacles; i++) {
					var boxEl = document.createElement('a-box');
					boxEl.setAttribute('material', {color: 'blue'});
					boxEl.setAttribute('position', {x: -xSize / 2 + Math.random() * xSize,
													y: -ySize / 2 + Math.random() * ySize,
													z: -zSize / 2 + Math.random() * zSize});
					boxEl.setAttribute('width', 20);
					boxEl.setAttribute('height', 20);
					boxEl.setAttribute('depth', 20);
					boxEl.setAttribute('static-body', 'shape: box');
					boxEl.setAttribute('holdable');
					var sceneEl = document.querySelector('a-scene');
					sceneEl.appendChild(boxEl);
				}

				for (var i = 0; i < dodgeballs; i++) {
					var boxEl = document.createElement('a-sphere');
					boxEl.setAttribute('material', {color: 'blue'});
					boxEl.setAttribute('position', {x: -xSize / 2 + Math.random() * xSize,
													y: -ySize / 2 + Math.random() * ySize,
													z: -zSize / 2 + Math.random() * zSize});
					boxEl.setAttribute('radius', 4);
					boxEl.setAttribute('dynamic-body', 'shape: sphere');
					boxEl.setAttribute('holdable');
					var sceneEl = document.querySelector('a-scene');
					sceneEl.appendChild(boxEl);
				}
			}

		</script>

		<a-scene physics="gravity: -3">
			<a-entity position="0 30 0" particle-system="preset: dust; particleCount: 10000; type: 1; velocityValue: 0 0 1; velocitySpread: 0 0 0; rotationAngle: 0"></a-entity>
			 <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
			 <a-box position="-1 0.5 -3" rotation="0 45 0" width="1000" height="50" depth="1000"  color="#4CC3D9"></a-box>
			 <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
			 <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
			 <a-sky color="#000"></a-sky>
			<a-box width=".5" height=".5" depth=".5" position="0.125 4 -4" color="red" holdable dynamic-body="shape: box"></a-box>
			<!-- <a-sky src="https://cdn.glitch.com/b870d9ec-1139-44f9-b462-223e4a2c74e7%2Fsechelt.jpg?1490307995926"></a-sky> -->
			<a-sphere id="player" radius="0.01" dynamic-body="shape: sphere; sphereRadius: 1" camera="near: 0.01;" look-controls position="0 1 0">
			<!-- <a-entity dynamic-body camera="near: 0.01" look-controls position="0 1.5 0"> -->
				<a-entity id="left" leap-hand="hand: left; enablePhysics: true; holdDistance: 1"></a-entity>
				<a-entity id="right" leap-hand="hand: right; enablePhysics: true; holdDistance: 1"></a-entity>
				<a-octahedron id="life-1" color="#FF926B" radius="0.1" position="0.3 0.6 -1"></a-octahedron>
				<a-octahedron id="life-2" color="#FF926B" radius="0.1" position="0.6 0.6 -1"></a-octahedron>
				<a-octahedron id="life-3" color="#FF926B" radius="0.1" position="0.9 0.6 -1"></a-octahedron>
			</a-sphere>
		</a-scene>
		<script>
			// let playerEl = document.querySelector('#player');
			// let lives = 3;
			// playerEl.addEventListener('body-loaded', bodyEvent => {
			// 	bodyEvent.detail.body.addEventListener('collide', () => {
			// 		let lifeEl = document.querySelector('#life-' + lives);
			// 		playerEl.removeChild(lifeEl);
			// 		lives--;
			// 	});
			// });
			generateMap(300, 300, 300, 4, 4);
		</script>
	</body>
</html>
