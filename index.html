<!DOCTYPE html>
<html>
	<head>
		<script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
		<script src="https://js.leapmotion.com/leap-0.6.4.min.js"></script>
		<script src="https://unpkg.com/aframe-leap-hands/dist/aframe-leap-hands.min.js"></script>
		<script src="https://unpkg.com/aframe-physics-system@1.4.0/dist/aframe-physics-system.min.js"></script>
		<script src="https://unpkg.com/aframe-firebase-component@^4.0.0/dist/aframe-firebase-component.min.js"></script>
		<script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
		<script src="https://unpkg.com/aframe-entity-generator-component@^3.0.0/dist/aframe-entity-generator-component.min.js"></script>

		<script>
			// controls unit conversion ratio between what we get back from the Leap and what CANNON.js takes
			// by default, just converting from millimeters to meters (1000) is too slow, so  go for something smaller than that
			const leapToCANNONRatio = 100;

			AFRAME.registerComponent('holdable', {
				schema: {activeColor: {default: 'orange'}},
				init() {
					this.physics 	= this.el.sceneEl.systems.physics;
					this.constraint = null;
					this.handID 	= null;
					this.el.addEventListener('leap-holdstart', this.onHoldStart.bind(this));
					this.el.addEventListener('leap-holdstop', this.onHoldStop.bind(this));
					console.log('initialized');
				},
				onHoldStart(e) {
					if (this.handID) return;
					this.originalColor = this.el.getAttribute('material').color;
					this.el.setAttribute('material', 'color', this.data.activeColor);
					this.constraint = new CANNON.LockConstraint(this.el.body, e.detail.body);
					this.physics.world.addConstraint(this.constraint);
					this.handID = e.detail.handID;
					console.log('holding');
				},
				onHoldStop(e) {
					if (e.detail.handID !== this.handID) return;
					this.el.setAttribute('material', 'color', this.originalColor);
					this.physics.world.removeConstraint(this.constraint);
					this.constraint = null;
					this.handID 	= null;
					this.el.body.velocity = new CANNON.Vec3(...speed.map(s => s / leapToCANNONRatio));
					console.log('thrown: ' + speed);
				}
			});
		</script>
	</head>
	<body>
		<script>
			const controller = new Leap.Controller({
				enableGestures: true,
				frameEventName: 'animationFrame'
			});

			let speed = [0, 0, 0];

			controller.on('frame', frame => {
				if (frame.hands.length != 0) {
					speed = frame.hands[0].palmVelocity;
				}
			});

			controller.connect();
		</script>

		<!-- https://github.com/ngokevin/kframe/tree/master/components/firebase -->
		<a-scene physics="gravity: -5" firebase="apiKey: AIzaSyCfSH6Ow32uPpMxBAA4PTrgBUiM72hSKqk;
												 authDomain: chicagohacks2017.firebaseapp.com;
												 databaseURL: https://chicagohacks2017.firebaseio.com;
												 storageBucket: chicagohacks2017.appspot.com">
			<a-assets>
				<!-- TODO -->
				<a-mixin id="ball" holdable dynamic-body="shape: sphere" random-position="min: -12.5 0 -12.5; max: 12.5 25 12.5" geometry="primitive: sphere; radius: 0.1" firebase-broadcast="components: mixin, position"></a-mixin>
				<a-mixin id="player-model"></a-mixin>
			</a-assets>
			<a-box width=".5" height=".5" depth=".5" position="0.125 4 -4" color="red" holdable dynamic-body="shape: box"></a-box>
			<a-plane static-body position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
			<a-sky src="https://cdn.glitch.com/b870d9ec-1139-44f9-b462-223e4a2c74e7%2Fsechelt.jpg?1490307995926"></a-sky>
			<a-entity entity-generator="mixin: ball; num: 10" firebase-broadcast="componentsOnce: mixin; components: position"></a-entity>
			<a-entity camera="near: 0.01" look-controls wasd-controls position="0 1 0">
			<!-- <a-entity dynamic-body camera="near: 0.01" look-controls position="0 1.5 0"> -->
				<a-entity id="left" leap-hand="hand: left; enablePhysics: true; holdDistance: 1"></a-entity>
				<a-entity id="right" leap-hand="hand: right; enablePhysics: true; holdDistance: 1"></a-entity>
			</a-entity>
		</a-scene>
	</body>
</html>
